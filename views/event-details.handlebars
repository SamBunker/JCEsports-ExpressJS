<head>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
<div class="nav-block"></div>
    <div class="container">
        <div class="col">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h2>{{event.title}}</h2>
                    <p class="text-muted">
                        {{#if isOldEvent}}
                            Legacy Event ‚Ä¢ {{#if event.is_public}}Public Event{{else}}Private Event{{/if}}
                        {{else}}
                            Organized by {{event.organizer_email}} ‚Ä¢ 
                            {{#if event.is_public}}Public Event{{else}}Private Event{{/if}}
                        {{/if}}
                    </p>
                    {{#if isOldEvent}}
                        <div class="alert alert-info">
                            <small>üìÖ This is a legacy calendar event. Enhanced features like invitations and RSVP tracking are available for new events.</small>
                        </div>
                    {{/if}}
                </div>
                {{#if canManage}}
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Manage Event
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showInviteModal()">üìß Send Invitations</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editEvent()">‚úèÔ∏è Edit Event</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteEvent()">üóëÔ∏è Delete Event</a></li>
                        </ul>
                    </div>
                {{/if}}
            </div>

            <div class="row">
                <!-- Event Details -->
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>üìÖ Event Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-3"><strong>When:</strong></div>
                                <div class="col-sm-9">
                                    {{event.start_date}} - {{event.end_date}}
                                </div>
                            </div>
                            {{#if event.location}}
                            <div class="row mt-2">
                                <div class="col-sm-3"><strong>Where:</strong></div>
                                <div class="col-sm-9">{{event.location}}</div>
                            </div>
                            {{/if}}
                            {{#if event.description}}
                            <div class="row mt-2">
                                <div class="col-sm-3"><strong>Description:</strong></div>
                                <div class="col-sm-9">{{event.description}}</div>
                            </div>
                            {{/if}}
                            {{#if event.max_attendees}}
                            <div class="row mt-2">
                                <div class="col-sm-3"><strong>Max Attendees:</strong></div>
                                <div class="col-sm-9">{{event.max_attendees}} people</div>
                            </div>
                            {{/if}}
                        </div>
                    </div>

                    <!-- RSVP Responses -->
                    {{#if rsvps}}
                    <div class="card">
                        <div class="card-header">
                            <h5>üë• Responses ({{rsvps.length}})</h5>
                        </div>
                        <div class="card-body">
                            {{#each rsvps}}
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                    <div>
                                        <strong>{{responder_name}}</strong>
                                        {{#if notes}}<br><small class="text-muted">{{notes}}</small>{{/if}}
                                    </div>
                                    <span class="badge badge-{{#eq response 'accept'}}success{{else}}{{#eq response 'maybe'}}warning{{else}}danger{{/eq}}{{/eq}}">
                                        {{#eq response 'accept'}}‚úÖ Attending{{/eq}}
                                        {{#eq response 'maybe'}}‚ùì Maybe{{/eq}}
                                        {{#eq response 'decline'}}‚ùå Not Attending{{/eq}}
                                    </span>
                                </div>
                            {{/each}}
                        </div>
                    </div>
                    {{/if}}
                </div>

                <!-- RSVP Summary Sidebar -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìä RSVP Summary</h5>
                        </div>
                        <div class="card-body">
                            {{#if rsvpSummary}}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>‚úÖ Attending:</span>
                                        <strong>{{rsvpSummary.accept}}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>‚ùì Maybe:</span>
                                        <strong>{{rsvpSummary.maybe}}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>‚ùå Not Attending:</span>
                                        <strong>{{rsvpSummary.decline}}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>üì¨ No Response:</span>
                                        <strong>{{rsvpSummary.no_response}}</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span><strong>Total Invited:</strong></span>
                                        <strong>{{totalInvited}}</strong>
                                    </div>
                                </div>
                            {{else}}
                                <p class="text-muted">No invitations sent yet.</p>
                            {{/if}}
                            
                            {{#if canManage}}
                                <button class="btn btn-primary btn-sm w-100" onclick="showInviteModal()">
                                    üìß Send More Invitations
                                </button>
                            {{/if}}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <a href="/teamschedule" class="btn btn-outline-secondary btn-sm w-100 mb-2">üóìÔ∏è View Calendar</a>
                            {{#if isLoggedIn}}
                                <a href="/dashboard" class="btn btn-outline-secondary btn-sm w-100">üìã My Dashboard</a>
                            {{/if}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Modal (if user can manage) -->
    {{#if canManage}}
    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìß Send Invitations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inviteForm">
                        <div class="mb-3">
                            <label for="inviteEmails" class="form-label">Email Addresses</label>
                            <textarea class="form-control" id="inviteEmails" rows="4" 
                                placeholder="Enter email addresses separated by commas&#10;Example: student1@juniata.edu, student2@juniata.edu"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendInvitations()">Send Invitations</button>
                </div>
            </div>
        </div>
    </div>
    {{/if}}

    <script>
        {{#if canManage}}
        function showInviteModal() {
            new bootstrap.Modal(document.getElementById('inviteModal')).show();
        }

        function sendInvitations() {
            const emails = document.getElementById('inviteEmails').value;
            if (!emails.trim()) {
                alert('Please enter at least one email address.');
                return;
            }

            fetch('/api/send-invitations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    eventId: '{{event.id}}',
                    createdAt: '{{event.created_at}}',
                    invitees: emails
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Sent ${data.emailsSent} invitations successfully!`);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send invitations.');
            });
        }

        function editEvent() {
            alert('Edit functionality coming soon!');
        }

        function deleteEvent() {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                alert('Delete functionality coming soon!');
            }
        }
        {{/if}}
    </script>
</body>